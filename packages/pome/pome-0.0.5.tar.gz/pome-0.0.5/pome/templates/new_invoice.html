{% extends 'base.html' %}
{% block main_title %}
New Invoice
{% endblock %}
{% block content %}

<div id="tx-error" class="hidden mb-10 bg-red-500 rounded-sm text-white p-5">

</div>

<div class="-mt-10">

  <div class="flex space-x-5 items-end">
    <form method="POST" action="/invoices/new/preset" class="flex items-start">
      <select name="preset" onchange="this.form.submit()" style="width:200px">
        {% for preset in preset_list %}
        <option value="{{preset}}" {% if preset==preset_filename %}selected{%endif%}>{{preset}}</option>
        {% endfor %}
      </select>
      <button class="btn btn-primary ml-4">
        Load preset
      </button>
    </form>

    <div>
      <h2 class="text-lg">Client</h2>
      <input type="text" name="invoice-client" value="{% if preset_client %}{{preset_client}}{% endif %}" />
    </div>

    <div>
      <h2 class="text-lg">Tags <span class="text-xs">(comma separated)</span></h2>
      <input type="text" name="invoice-tags" value="{% if preset_client %}{{preset_tags}}{% endif %}" />
    </div>

  </div>

  <div class="flex mt-3 space-x-5">
    <div>
      <h2 class="text-lg">Invoice Number</h2>

      <div class=" bg-pink-500 rounded-sm text-sm text-white p-3 mb-2" style="width: 200px">
        Please pull to be up to date with latest invoice number.
      </div>
      <div class="flex space-x-5">
        <input type="text" name="invoice-number"
          value="{% if preset_invoice_number %}{{preset_invoice_number}}{% endif %}" />
        <div class="flex space-x-1 items-center">
          <input type="checkbox" name="invoice-counter-increment" id="invoice-counter-increment" checked />
          <label class="select-none" for="invoice-counter-increment">Increment invoice counter</label>
        </div>
      </div>
    </div>


  </div>

  <div class="flex mt-1">


    <div>
      <h1 class="text-2xl">Invoice</h1>
      <textarea rows="{{textarea_bill_height}}" cols="60" id="tx-bill" data-gramm="false" data-gramm_editor="false"
        data-enable-grammarly="false">{% if preset_transaction_bill %}{{preset_transaction_bill}}{%endif%}</textarea>
      <script>$('#tx-bill').highlightWithinTextarea({
          highlight: ["??", "__"],

        });</script>
      <div class="flex space-x-10 items-start mt-5">

        <div>
          The invoice is:
          <div class="pl-4">
            <div>
              <input type="radio" id="tx-invoice-pending" name="invoice-status" value="pending" checked>
              <label for="tx-invoice-pending" class="select-none cursor-pointer">Pending</label>
            </div>
            <div>
              <input type="radio" id="tx-invoice-paid" name="invoice-status" value="paid">
              <label for="tx-invoice-paid" class="select-none cursor-pointer">Paid</label>
            </div>
          </div>
          <script>
            $('input[type=radio][name=invoice-status]').change(function () {
              if (this.value == 'pending') {
                $('#panel-payment').addClass("hidden");
              }
              else if (this.value == 'paid') {
                $('#panel-payment').removeClass("hidden");
              }
            });
          </script>
        </div>
        <div>
          <div class="w-full" id="tx-attachments">
            <div class="text-xl font-bold block mb-1">Attachments</div>

            {% for i in range(2) %}
            <div class="mb-2 w-full {% if i == 0 %}hidden {%endif%}" id="div-tx-file-{{i}}">
              <label for="tx-file-{{i}}" class="btn btn-secondary">Choose file</label>
              <input class="hidden select-none" type="file" id="tx-file-{{i}}" onchange="updateFile(this)" />
              <span class="hidden">
                <span class="pl-2 normal-link"></span>
                <span class="pl-2 cursor-pointer" title="Delete file" onclick="deleteFile(this)"
                  id="delete-tx-file-{{i}}">❌</span>
              </span>
            </div>
            {% endfor %}

          </div>
          <div class="btn btn-primary mt-3" onclick="addFile(this)">Add Attachment</div>
        </div>

        <div class="flex flex-col justify-end space-y-4">
          <a href="/invoices">
            <div class="btn btn-secondary text-lg">Cancel</div>
          </a>
          <div id="btn-bill-record" class="btn btn-primary text-lg" onclick="postInvoicePayload(this)">Record Invoice
          </div>
        </div>

      </div>
    </div>


    <div class="ml-5 hidden" id="panel-payment">
      <h1 class="text-2xl">Payment</h1>
      <textarea rows="{{textarea_payment_height}}" cols="60" id="tx-payment" data-gramm="false"
        data-gramm_editor="false"
        data-enable-grammarly="false">{% if preset_transaction_payment %}{{preset_transaction_payment}}{%endif%}</textarea>
      <script>$('#tx-payment').highlightWithinTextarea({
          highlight: ["??", "__"],

        });</script>
    </div>
  </div>


  <div id="pdf-error" class="hidden mt-10 bg-red-500 rounded-sm text-white p-5">

  </div>
  <div class="mt-8">
    <h1 class="text-2xl mb-2">Generate PDF invoice <div class="btn btn-primary text-base ml-2"
        onclick="postPDFInvoicePayload(this, '{{doc_filler_URL}}')" id="pdf-button">Generate PDF <div
          class="spinner hidden" id="spinner-PDF">
          <div class="bounce1"></div>
          <div class="bounce2"></div>
          <div class="bounce3"></div>
        </div>
      </div>
    </h1>
    <textarea id="meta-invoice-payload" rows="{{textarea_meta_invoice_height}}" cols="60" id="meta-invoice"
      data-gramm="false" data-gramm_editor="false" data-enable-grammarly="false">{% if preset_meta_invoice_payload %}{{preset_meta_invoice_payload}}{%else%}{
        "template": "codepro_misc.html",
        "payload": {
          "invoice_number": "",
          "date_created": "",
          "date_due": "",
          "date_paid": "",
          "client_information": {
            "name": {
              "first": "",
              "midlle": "",
              "last": ""
            },
            "company": {
              "company_name": "",
              "vat_number": ""
            },
            "email": "",
            "billing_address": {
              "country_code": "",
              "line1": "",
              "line2": "",
              "line3": "",
              "county": "",
              "postcode": ""
            }
          },
          "_items": [
            {
              "name": "",
              "qty": 1,
              "unit_price": "",
              "amount": ""
            }
          ],
          "subtotal": "",
          "total": ""
        }
      }{%endif%}</textarea>
    <script>$('#meta-invoice-payload').highlightWithinTextarea({
        highlight: ["??", "__"],

      });</script>
  </div>

</div>

<script src="{{url_for('static', filename='invoice.js')}}"></script> {% endblock %}
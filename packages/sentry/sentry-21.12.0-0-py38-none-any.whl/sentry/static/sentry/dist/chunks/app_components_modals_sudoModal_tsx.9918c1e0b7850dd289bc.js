"use strict";(self.webpackChunk=self.webpackChunk||[]).push([["app_components_modals_sudoModal_tsx","U2fSign"],{"./app/components/modals/sudoModal.tsx":(e,t,s)=>{s.r(t),s.d(t,{SudoModal:()=>v,default:()=>E});var n=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=s("../node_modules/@emotion/styled/base/dist/emotion-styled-base.browser.esm.js"),o=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/core-js/modules/es.string.replace.js"),s("../node_modules/react/index.js")),i=s("../node_modules/react-router/es/index.js"),a=s("./app/components/alert.tsx"),l=s("./app/components/button.tsx"),d=s("./app/utils/withApi.tsx"),p=s("./app/components/u2f/u2fsign.tsx"),c=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class u extends o.Component{constructor(...e){super(...e),(0,n.Z)(this,"state",{authenticators:[]})}componentDidMount(){this.getAuthenticators()}async getAuthenticators(){const{api:e}=this.props;try{const t=await e.requestPromise("/authenticators/");this.setState({authenticators:null!=t?t:[]})}catch{}}render(){const{className:e}=this.props,{authenticators:t}=this.state;return t.length?(0,c.tZ)("div",{className:e,children:t.map((e=>"u2f"===e.id&&e.challenge?(0,c.tZ)(p.default,{...this.props,challengeData:e.challenge},e.id):null))}):null}}u.displayName="U2fContainer";const h=(0,d.Z)(u);var m=s("./app/icons/index.tsx"),g=s("./app/locale.tsx"),f=s("./app/stores/configStore.tsx"),y=s("./app/styles/space.tsx"),b=s("./app/views/settings/components/forms/form.tsx"),Z=s("./app/views/settings/components/forms/inputField.tsx"),w=s("./app/views/settings/components/text/textBlock.tsx");class v extends o.Component{constructor(...e){super(...e),(0,n.Z)(this,"state",{error:!1,busy:!1}),(0,n.Z)(this,"handleSuccess",(()=>{const{closeModal:e,superuser:t,location:s,router:n,retryRequest:r}=this.props;r?t?n.replace({pathname:s.pathname,state:{forceUpdate:new Date}}):this.setState({busy:!0},(()=>{r().then((()=>{this.setState({busy:!1},e)}))})):e()})),(0,n.Z)(this,"handleError",(()=>{this.setState({busy:!1,error:!0})})),(0,n.Z)(this,"handleU2fTap",(async e=>{this.setState({busy:!0});const{api:t}=this.props;try{await t.requestPromise("/auth/",{method:"PUT",data:e}),this.handleSuccess()}catch(e){throw this.setState({busy:!1}),e}}))}renderBodyContent(){const{superuser:e}=this.props,{error:t}=this.state,s=f.Z.get("user");return s.hasPasswordAuth?(0,c.BX)(o.Fragment,{children:[(0,c.tZ)(S,{children:e?(0,g.t)("You are attempting to access a resource that requires superuser access, please re-authenticate as a superuser."):(0,g.t)("Help us keep your account safe by confirming your identity.")}),t&&(0,c.tZ)(U,{type:"error",icon:(0,c.tZ)(m.Gy,{size:"md"}),children:(0,g.t)("Incorrect password")}),(0,c.BX)(b.Z,{apiMethod:"PUT",apiEndpoint:"/auth/",submitLabel:(0,g.t)("Confirm Password"),onSubmitSuccess:this.handleSuccess,onSubmitError:this.handleError,hideFooter:!s.hasPasswordAuth,resetOnError:!0,children:[(0,c.tZ)(x,{type:"password",inline:!1,label:(0,g.t)("Password"),name:"password",autoFocus:!0,flexibleControlStateSize:!0}),(0,c.tZ)(h,{displayMode:"sudo",onTap:this.handleU2fTap,isWebauthnSigninFFEnabled:!1})]})]}):(0,c.BX)(o.Fragment,{children:[(0,c.tZ)(w.Z,{children:(0,g.t)("You will need to reauthenticate to continue.")}),(0,c.tZ)(l.ZP,{priority:"primary",href:"/auth/login/?next=".concat(encodeURIComponent(location.pathname)),children:(0,g.t)("Continue")})]})}render(){const{Header:e,Body:t}=this.props;return(0,c.BX)(o.Fragment,{children:[(0,c.tZ)(e,{closeButton:!0,children:(0,g.t)("Confirm Password to Continue")}),(0,c.tZ)(t,{children:this.renderBodyContent()})]})}}v.displayName="SudoModal";const E=(0,i.withRouter)((0,d.Z)(v)),S=(0,r.Z)(w.Z,{target:"egngqnr2"})("margin-bottom:",(0,y.Z)(1),";"),x=(0,r.Z)(Z.Z,{target:"egngqnr1"})({name:"1408f10",styles:"padding-left:0"}),U=(0,r.Z)(a.Z,{target:"egngqnr0"})({name:"1ykowef",styles:"margin-bottom:0"})},"./app/components/u2f/u2fsign.tsx":(e,t,s)=>{s.r(t),s.d(t,{default:()=>y});var n=s("../node_modules/@babel/runtime/helpers/esm/defineProperty.js"),r=s("../node_modules/react/index.js"),o=s("./app/locale.tsx"),i=(s("../node_modules/core-js/modules/web.dom-collections.iterator.js"),s("../node_modules/@sentry/minimal/esm/index.js")),a=s("../node_modules/u2f-api/dist/index.js"),l=s.n(a);function d(e){const t="==".slice(0,(4-e.length%4)%4),s=e.replace(/-/g,"+").replace(/_/g,"/")+t,n=atob(s),r=new ArrayBuffer(n.length),o=new Uint8Array(r);for(let e=0;e<n.length;e++)o[e]=n.charCodeAt(e);return r}function p(e){const t=new Uint8Array(e);let s="";for(const e of t)s+=String.fromCharCode(e);return btoa(s).replace(/\+/g,"-").replace(/\//g,"_").replace(/=/g,"")}s("../node_modules/core-js/modules/es.string.replace.js"),s("../node_modules/core-js/modules/es.array-buffer.slice.js"),s("../node_modules/core-js/modules/es.typed-array.uint8-array.js"),s("../node_modules/core-js/modules/es.typed-array.sort.js");var c=s("./app/stores/configStore.tsx"),u=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");class h extends r.Component{constructor(...e){super(...e),(0,n.Z)(this,"state",{isSupported:null,formElement:null,challengeElement:null,hasBeenTapped:!1,deviceFailure:null,responseElement:null}),(0,n.Z)(this,"onTryAgain",(()=>{this.setState({hasBeenTapped:!1,deviceFailure:null},(()=>{this.invokeU2fFlow()}))})),(0,n.Z)(this,"bindChallengeElement",(e=>{this.setState({challengeElement:e,formElement:e&&e.form}),e&&(e.value=JSON.stringify(this.props.challengeData))})),(0,n.Z)(this,"bindResponseElement",(e=>this.setState({responseElement:e}))),(0,n.Z)(this,"renderFailure",(()=>{const{deviceFailure:e}=this.state,t=c.Z.get("supportEmail"),s=t?(0,u.tZ)("a",{href:"mailto:"+t,children:t}):(0,u.tZ)("span",{children:(0,o.t)("Support")});return(0,u.BX)("div",{className:"failure-message",children:[(0,u.BX)("div",{children:[(0,u.tZ)("strong",{children:(0,o.t)("Error: ")})," ",{UNKNOWN_ERROR:(0,o.t)("There was an unknown problem, please try again"),DEVICE_ERROR:(0,o.t)("Your U2F device reported an error."),DUPLICATE_DEVICE:(0,o.t)("This device is already registered with Sentry."),UNKNOWN_DEVICE:(0,o.t)("The device you used for sign-in is unknown."),BAD_APPID:(0,o._N)("[p1:The Sentry server administrator modified the device registrations.][p2:You need to remove and re-add the device to continue using your U2F device. Use a different sign-in method or contact [support] for assistance.]",{p1:(0,u.tZ)("p",{}),p2:(0,u.tZ)("p",{}),support:s})}[e||""]]}),this.canTryAgain&&(0,u.tZ)("div",{style:{marginTop:18},children:(0,u.tZ)("a",{onClick:this.onTryAgain,className:"btn btn-primary",children:(0,o.t)("Try Again")})})]})}))}async componentDidMount(){const e=this.props.isWebauthnSigninFFEnabled?!!window.PublicKeyCredential:await l().isSupported();this.setState({isSupported:e}),e&&this.invokeU2fFlow()}getU2FResponse(e){if(!e.response)return JSON.stringify(e);const t={keyHandle:e.id,clientData:p(e.response.clientDataJSON),signatureData:p(e.response.signature),authenticatorData:p(e.response.authenticatorData)};return JSON.stringify(t)}submitU2fResponse(e){e.then((e=>{this.setState({hasBeenTapped:!0},(()=>{const t=this.getU2FResponse(e),s=JSON.stringify(this.props.challengeData);var n;this.state.responseElement&&(this.state.responseElement.value=t),this.props.onTap?this.props.onTap({response:t,challenge:s}).catch((()=>{this.setState({deviceFailure:"UNKNOWN_ERROR",hasBeenTapped:!1})})):null===(n=this.state.formElement)||void 0===n||n.submit()}))})).catch((e=>{let t="DEVICE_ERROR";e.metaData&&("DEVICE_INELIGIBLE"===e.metaData.type?t="enroll"===this.props.flowMode?"DUPLICATE_DEVICE":"UNKNOWN_DEVICE":"BAD_REQUEST"===e.metaData.type&&(t="BAD_APPID")),i.Tb(e),this.setState({deviceFailure:t,hasBeenTapped:!1})}))}webAuthnSignIn(e){const t=[],s=e[0].challenge,n=e[0].appId;e.forEach((e=>{t.push({id:d(e.keyHandle),type:"public-key",transports:["usb","ble","nfc"]})}));const r={challenge:d(s),allowCredentials:t,userVerification:"discouraged",extensions:{appid:n}},o=navigator.credentials.get({publicKey:r});this.submitU2fResponse(o)}invokeU2fFlow(){let e;if("sign"===this.props.flowMode)this.props.isWebauthnSigninFFEnabled?this.webAuthnSignIn(this.props.challengeData.authenticateRequests):(e=l().sign(this.props.challengeData.authenticateRequests),this.submitU2fResponse(e));else{if("enroll"!==this.props.flowMode)throw new Error("Unsupported flow mode '".concat(this.props.flowMode,"'"));{const{registerRequests:t,registeredKeys:s}=this.props.challengeData;e=l().register(t,s),this.submitU2fResponse(e)}}}renderUnsupported(){return this.props.silentIfUnsupported?null:(0,u.tZ)("div",{className:"u2f-box",children:(0,u.tZ)("div",{className:"inner",children:(0,u.tZ)("p",{className:"error",children:(0,o.t)("\n             Unfortunately your browser does not support U2F. You need to use\n             a different two-factor method or switch to a browser that supports\n             it (Google Chrome or Microsoft Edge).")})})})}get canTryAgain(){return"BAD_APPID"!==this.state.deviceFailure}renderBody(){return this.state.deviceFailure?this.renderFailure():this.props.children}renderPrompt(){const{style:e}=this.props;return(0,u.BX)("div",{style:e,className:"u2f-box"+(this.state.hasBeenTapped?" tapped":"")+(this.state.deviceFailure?" device-failure":""),children:[(0,u.BX)("div",{className:"device-animation-frame",children:[(0,u.tZ)("div",{className:"device-failed"}),(0,u.tZ)("div",{className:"device-animation"}),(0,u.BX)("div",{className:"loading-dots",children:[(0,u.tZ)("span",{className:"dot"}),(0,u.tZ)("span",{className:"dot"}),(0,u.tZ)("span",{className:"dot"})]})]}),(0,u.tZ)("input",{type:"hidden",name:"challenge",ref:this.bindChallengeElement}),(0,u.tZ)("input",{type:"hidden",name:"response",ref:this.bindResponseElement}),(0,u.tZ)("div",{className:"inner",children:this.renderBody()})]})}render(){const{isSupported:e}=this.state;return null===e?null:e?this.renderPrompt():this.renderUnsupported()}}h.displayName="U2fInterface";const m=h,g={signin:(0,o.t)("Insert your U2F device or tap the button on it to confirm the sign-in request."),sudo:(0,o.t)("Alternatively you can use your U2F device to confirm the action."),enroll:(0,o.t)("To enroll your U2F device insert it now or tap the button on it to activate it.")};class f extends r.Component{render(){const{displayMode:e,...t}=this.props,s="enroll"===e?"enroll":"sign";return(0,u.tZ)(m,{...t,silentIfUnsupported:"sudo"===e,flowMode:s,children:(0,u.tZ)("p",{children:g[e]||null})})}}f.displayName="U2fSign",(0,n.Z)(f,"defaultProps",{displayMode:"signin"});const y=f},"./app/utils/useApi.tsx":(e,t,s)=>{s.d(t,{Z:()=>o});var n=s("../node_modules/react/index.js"),r=s("./app/api.tsx");const o=function({persistInFlight:e,api:t}={}){const s=(0,n.useRef)();void 0===s.current&&void 0===t&&(s.current=new r.KU);const o=null!=t?t:s.current;function i(){!e&&o.clear()}return(0,n.useEffect)((()=>i),[]),o}},"./app/utils/withApi.tsx":(e,t,s)=>{s.d(t,{Z:()=>i});var n=s("./app/utils/getDisplayName.tsx"),r=s("./app/utils/useApi.tsx"),o=s("../node_modules/@emotion/react/jsx-runtime/dist/emotion-react-jsx-runtime.browser.esm.js");const i=(e,t={})=>{const s=({api:s,...n})=>{const i=(0,r.Z)({api:s,...t});return(0,o.tZ)(e,{...n,api:i})};return s.displayName="withApi(".concat((0,n.Z)(e),")"),s}}}]);
//# sourceMappingURL=../sourcemaps/app_components_modals_sudoModal_tsx.2dd5c9e9f769f874e9d6fd4b6de2e6f7.js.map